# STM32CubeMX 与 Keil5 详细开发流程笔记

## 一、STM32CubeMX 与 Keil5 的关系

### 1. 功能定位的互补性
STM32CubeMX 是底层配置工具，专注于硬件抽象层（HAL）的自动化配置，通过图形化界面完成芯片选型、外设初始化、时钟树分配等底层工作，降低硬件配置的技术门槛。而 Keil5 是集成开发环境（IDE），聚焦于应用代码的编写、编译、调试和下载，提供专业的代码编辑工具和硬件调试接口，负责将底层配置与上层逻辑结合并生成可执行程序。两者形成 “底层配置→上层开发→硬件验证” 的完整开发闭环。

### 2. 数据交互的关联性
- **项目文件衔接**：STM32CubeMX 生成的代码包中包含 Keil5 专用的项目文件（.uvprojx），该文件已预设好芯片型号、编译规则、库文件路径等参数，直接导入 Keil5 即可无缝启动开发，避免手动配置项目的繁琐操作。
- **代码结构兼容**：CubeMX 生成的初始化代码（如 main.c、stm32fxxx_hal_msp.c）遵循 Keil5 的编译规范，用户在 Keil5 中编写的应用代码可直接调用 CubeMX 生成的 HAL 库函数，两者共享同一套头文件和全局变量定义，确保代码逻辑的连贯性。
- **迭代更新的协同性**：当通过 CubeMX 修改硬件配置（如新增外设、调整时钟频率）并重新生成代码时，Keil5 会自动识别更新后的文件（需勾选 “Keep user code when re-generating” 选项），保留用户在 Keil5 中编写的应用代码，仅更新底层配置部分，实现 “配置修改→代码同步→重新编译” 的高效迭代。

### 3. 开发流程的依赖性
脱离 STM32CubeMX 时，Keil5 需手动编写大量底层初始化代码（如寄存器配置、时钟使能），开发效率低且易出错；而脱离 Keil5 时，CubeMX 仅能生成代码框架，无法完成应用逻辑开发和硬件调试，两者缺一不可。

典型协同场景：CubeMX 负责搭建 “硬件骨架”，Keil5 负责填充 “功能血肉”，最终通过 Keil5 的调试功能验证整个系统的运行状态，形成 “配置→开发→验证” 的依赖链条。

## 二、STM32CubeMX 配置阶段（详细步骤）

### 软件启动与芯片选型
打开 STM32CubeMX 软件，首次启动会显示欢迎界面，点击 “New Project” 进入项目创建页面。

在左侧菜单栏选择 “MCU Selector”，在搜索框输入目标芯片型号（如 “STM32F103C8T6”），在搜索结果中点击对应芯片，右侧会显示芯片引脚数量、Flash 容量等参数，确认无误后点击 “Start Project”。

若之前有保存的配置模板，可通过 “File -> Load Project” 加载模板，快速复用配置。

### 外设配置细节
- **GPIO 配置**：在右侧引脚分布图中点击目标引脚，选择功能模式（如 GPIO_Output、GPIO_Input、Alternate Function）。若选择复用功能（如 UART 的 TX/RX），需在弹出的下拉菜单中指定具体外设（如 USART1_TX）。
- **外设参数设置**：点击左侧 “Configuration” 栏中的外设（如 USART1），在弹出的配置界面设置参数：
  - 波特率（如 115200）、数据位（8 位）、停止位（1 位）、校验位（None）。
  - 中断使能：若需使用中断，勾选 “NVIC Settings” 中的 “Enabled”，并设置中断优先级。
- **定时器配置**：选择定时器（如 TIM2），设置时钟源（内部时钟 / 外部触发）、预分频系数、自动重装载值，使能定时器中断（如需）。

### 时钟树配置详解
点击 “Clock Configuration” 进入时钟配置界面，顶部显示芯片默认时钟源（HSI 内部高速时钟 / 外部晶振 HSE）。

若使用外部晶振，需在 “Pinout & Configuration” 界面中先使能 HSE（勾选 “Crystal/Ceramic Resonator”）。

配置步骤：
1. 选择 PLL 时钟源（如 HSE 作为 PLL 输入）。
2. 设置 PLL 分频系数（PLLM）、倍频系数（PLLN）、输出分频（PLLP），确保系统时钟（SYSCLK）不超过芯片最大频率（如 STM32F1 系列最大 72MHz）。
3. 为外设时钟（APB1、APB2）分配频率，注意 APB1 最大频率通常为系统时钟的一半。
4. 点击 “OK” 保存时钟配置，若参数超出范围会提示错误，需重新调整。

### 中间件配置（以 FreeRTOS 为例）
在左侧 “Middleware” 中勾选 “FreeRTOS”，选择版本（如 V1）。

在 “Tasks and Queues” 中点击 “Add” 创建任务：设置任务名称、优先级（数值越大优先级越高）、堆栈大小、入口函数名。

配置队列、信号量等同步机制（如需），在 “Queues/Semaphores” 中添加并设置参数。

### 代码生成设置与执行
点击 “Project Manager”，在 “Project” 栏设置：
- 项目名称（避免中文和空格）、存储路径（建议路径简短，如 “D:\STM32_Project”）。
- 工具链 / IDE 选择 “MDK-ARM”，版本选择 “V5”。

在 “Code Generator” 栏勾选：
- “Generate peripheral initialization as a pair of '.c/.h' files per peripheral”（外设初始化代码分文件存放）。
- “Keep user code when re-generating”（重新生成代码时保留用户添加的代码）。
- “Generate under root folder”（在根目录生成代码，避免多层文件夹）。

点击 “Generate Code”，软件会自动生成代码并提示 “Code Generation Complete”，点击 “Open Project” 可直接启动 Keil5。

## 三、Keil5 开发阶段（详细步骤）

### 项目加载与环境配置
若未通过 CubeMX 直接打开，手动启动 Keil5，点击 “Project -> Open Project”，浏览到 CubeMX 生成的项目文件夹，选择 “.uvprojx” 文件打开。

首次打开项目需等待索引完成（底部状态栏显示 “Parsing...”），完成后左侧 “Project” 窗口显示文件结构。

配置目标选项：点击工具栏 “Options for Target”（魔术棒图标）：
- 在 “Device” 栏确认芯片型号是否正确（如 “STM32F103C8”）。
- 在 “Output” 栏勾选 “Create HEX File”（生成可下载的 hex 文件），勾选 “Browse Information”（支持代码跳转）。

### 应用代码编写规范
在 “Src” 文件夹中找到 “main.c”，双击打开，用户代码需写在指定注释区间内：
```c
/* USER CODE BEGIN 1 */
// 此处可定义全局变量、函数声明
/* USER CODE END 1 */
```

在main()函数的初始化后编写主逻辑：
```c
/* USER CODE BEGIN 2 */
// 初始化完成后的用户代码，如开启中断、启动 FreeRTOS 调度器
/* USER CODE END 2 */

/* Infinite loop */
/* USER CODE BEGIN WHILE */
while (1)
{
    // 循环执行的代码，如数据处理、外设操作
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
}
/* USER CODE END 3 */
```

新增自定义文件：右键 “Project” 窗口中的 “Src” 文件夹，选择 “Add New Item to Group 'Src'”，创建 “.c” 文件（如 “user_func.c”），同时在 “Inc” 文件夹添加对应 “.h” 文件，并在 “main.c” 中通过`#include "user_func.h"`引用。

### 代码编译与错误处理
点击工具栏 “Build”（或按 F7）进行编译，底部 “Build Output” 窗口显示编译过程：
- 若显示 “0 Error (s), 0 Warning (s)”，编译成功。
- 若有错误（Error），根据提示定位行号（如 “main.c (25): error: ...”），修改语法错误（如缺少分号、函数未声明）。
- 警告（Warning）可暂时忽略，但建议检查（如变量未使用、类型转换隐患）。

点击 “Rebuild” 可强制重新编译所有文件（适用于修改头文件后）。

## 四、调试与下载阶段（详细步骤）

### 硬件连接准备
连接调试器：将 ST-Link/V2 调试器的 SWCLK、SWDIO 引脚与目标板对应引脚连接，同时连接 GND（共地）和 VCC（为调试器供电，注意电压匹配）。

将调试器 USB 端插入电脑，电脑会自动安装驱动（若未安装，需手动安装 ST-Link 驱动）。

### Keil 调试配置
点击 “Options for Target -> Debug”，在 “Use” 下拉菜单选择 “ST-Link Debugger”，点击右侧 “Settings”：
- 在 “Interface” 栏选择 “SW”（默认，比 JTAG 更节省引脚）。
- 点击 “Connect”，若显示 “ST-Link connected” 和芯片 ID，则连接成功；若失败，检查接线和驱动。

在 “Flash Download” 栏勾选 “Reset and Run”（下载后自动运行程序），点击 “Add” 选择目标芯片的 Flash 类型（如 “STM32F1xx 512KB Flash”）。

### 程序下载与验证
点击工具栏 “Load”（或按 F8），Keil 会将 hex 文件下载到芯片 Flash 中，底部显示 “Download completed successfully”。

下载完成后，目标板会自动复位并运行程序，可通过观察 LED、串口输出等现象验证程序是否正常启动。

### 断点调试技巧
进入调试模式：点击 “Start/Stop Debug Session”（或按 Ctrl+F5），界面变为调试视图，左侧显示寄存器和变量，底部显示内存数据。

常用调试按钮：
- “Step”（F11）：单步执行，进入函数内部。
- “Step Over”（F10）：单步执行，不进入函数内部。
- “Run”（F5）：继续运行到下一个断点。
- “Breakpoint”：在代码行左侧点击设置断点（红色圆点），程序运行到此处会暂停。

查看变量：在 “Watch 1” 窗口输入变量名，可实时观察其值；鼠标悬停在变量上也会显示当前值。

查看外设寄存器：在 “Peripherals” 菜单中选择对应外设（如 “GPIO -> GPIOA”），可直观查看寄存器状态（如输出电平、中断标志）。

### 调试后处理
若发现逻辑错误，点击 “Stop Debug Session” 退出调试，修改代码后重新编译、下载、调试。

调试完成后，建议保存项目（Ctrl+S），并备份 hex 文件（位于项目 “Output” 文件夹）。

## 五、开发收尾与优化
- **功能验证**：通过多种场景测试程序（如输入不同参数、模拟异常情况），确保所有功能符合设计需求。
- **代码优化**：
  - 减少冗余代码，合并重复逻辑为函数。
  - 优化变量类型（如用 uint8_t 代替 int，节省内存）。
  - 调整循环和中断处理，降低 CPU 占用率。
- **文档记录**：更新项目文档，记录引脚分配、时钟配置、关键函数功能等，便于后续维护。